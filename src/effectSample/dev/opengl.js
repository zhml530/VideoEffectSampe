"use strict";let canvas,gl,meshCanvas,meshCanvasCtx,program,positionLocation,texcoordLocation,orncoordLocation1,orncoordLocation2,orncoordLocation3,orncoordLocation4,orncoordLocation5,orncoordLocation6,orncoordLocation7,textureLocation,orntextureLocation1,orntextureLocation2,orntextureLocation3,orntextureLocation4,orntextureLocation5,orntextureLocation6,orntextureLocation7,resolutionLocation,mouthOpenFlagLocation,currentEffect,initContextFlag=!1,initCuteCatImageFlag=!1;canvas=document.createElement("canvas"),gl=canvas.getContext("webgl"),meshCanvas=document.createElement("canvas"),meshCanvasCtx=meshCanvas.getContext("2d");let processedImageArr,processedArrayBuffer,beardLFrames,beardRFrames,catfoodFrames,earLFrames,earRFrames,tailFrames,miaoFrames,predictions=[],maxEventDuration=1,eventStartTime=new Date,i=0,numFrame=8,updateFrequency=3,dumpCount=0;function getShader(e,t){var a=gl.createShader(t);return gl.shaderSource(a,e),gl.compileShader(a),gl.getShaderParameter(a,gl.COMPILE_STATUS)?a:(alert("ERROR IN SHADER : "+gl.getShaderInfoLog(a)),!1)}function initContext(e){if(!initContextFlag||e!=currentEffect){var t=vertexShaderSource,a=fragmentShaderSource[e],r=getShader(t,gl.VERTEX_SHADER),o=getShader(a,gl.FRAGMENT_SHADER);program=gl.createProgram(),gl.attachShader(program,r),gl.attachShader(program,o),gl.linkProgram(program),positionLocation=gl.getAttribLocation(program,"position"),texcoordLocation=gl.getAttribLocation(program,"texCoord"),orncoordLocation1=gl.getAttribLocation(program,"coordinateOrn1"),orncoordLocation2=gl.getAttribLocation(program,"coordinateOrn2"),orncoordLocation3=gl.getAttribLocation(program,"coordinateOrn3"),orncoordLocation4=gl.getAttribLocation(program,"coordinateOrn4"),orncoordLocation5=gl.getAttribLocation(program,"coordinateOrn5"),orncoordLocation6=gl.getAttribLocation(program,"coordinateOrn6"),orncoordLocation7=gl.getAttribLocation(program,"coordinateOrn7"),resolutionLocation=gl.getUniformLocation(program,"resolution"),textureLocation=gl.getUniformLocation(program,"texture"),orntextureLocation1=gl.getUniformLocation(program,"frameOrn1"),orntextureLocation2=gl.getUniformLocation(program,"frameOrn2"),orntextureLocation3=gl.getUniformLocation(program,"frameOrn3"),orntextureLocation4=gl.getUniformLocation(program,"frameOrn4"),orntextureLocation5=gl.getUniformLocation(program,"frameOrn5"),orntextureLocation6=gl.getUniformLocation(program,"frameOrn6"),orntextureLocation7=gl.getUniformLocation(program,"frameOrn7"),mouthOpenFlagLocation=gl.getUniformLocation(program,"mouthOpen"),initContextFlag=!0,currentEffect=e}}async function processImage(e,t,a,r){void 0!==t&&(resizeCanvas(canvas,e.width,e.height),resizeCanvas(meshCanvas,e.width,e.height),"facemask"==t?await showMesh(e,r):"cutecat"==t?(await initCuteCatImage(),initContext(t),await glRenderCuteCat(e,a)):(initContext(t),glRender(e)))}async function initFaceModel(e,t){if(null!=t&&!initFaceModelFlag){for(var a=new Array(1228800).fill(0),r=new Uint8ClampedArray(a,0,1228800),o=(new ImageData(r,640,480),0);o<1;o++){var g=Date.now();const t=new Uint8ClampedArray(e.data.slice(0,1228800),1228800);new ImageData(t,640,480);var l=Date.now();console.log("warm up:",l-g)}initFaceModelFlag=!0}}async function initCuteCatImage(){async function e(e,t){for(var a=[],r=1;r<=t;r++)a.push(await onloadImage("ornaments/"+e+"_"+r+".png"));return a}initCuteCatImageFlag||(beardLFrames=await e("BeardL",8),beardRFrames=await e("BeardR",8),catfoodFrames=await e("Catfood",8),earLFrames=await e("EarL",8),earRFrames=await e("EarR",8),tailFrames=await e("Tail",8),miaoFrames=await e("Miao",1),initCuteCatImageFlag=!0)}async function showMesh(e,t){await initFaceModel(),i+=1;const a=new Uint8ClampedArray(e.data,0,e.height*e.width*4);var r=new ImageData(a,e.width,e.height);meshCanvasCtx.putImageData(r,0,0);var o=Date.now();i%2==0&&(predictions=await t.estimateFaces(r));var g=Date.now();console.log("time:",g-o),predictions.forEach(e=>{const t=e.scaledMesh;meshCanvasCtx.strokeStyle="#32EEDB",meshCanvasCtx.lineWidth=.5;for(let e=0;e<TRIANGULATION.length/3;e++){const a=[TRIANGULATION[3*e],TRIANGULATION[3*e+1],TRIANGULATION[3*e+2]].map(e=>t[e]);drawPath(meshCanvasCtx,a,!0)}});var l=meshCanvasCtx.getImageData(0,0,e.width,e.height);e.data.set(l.data,0)}async function glRenderCuteCat(e,t){if(dumpCount%updateFrequency==0&&i++,dumpCount++,!gl)return;const a=new Uint8ClampedArray(e.data,0,e.height*e.width*4);var r=new ImageData(a,e.width,e.height),o=Date.now();dumpCount%2==0&&(predictions=await faceModel.estimateFaces(r));var g=Date.now();if(console.log("time:",g-o),predictions.length>0){var l={x_left_beard:predictions[0].scaledMesh[187][0]/e.width,y_left_beard:1-predictions[0].scaledMesh[187][1]/e.height,x_right_beard:predictions[0].scaledMesh[411][0]/e.width,y_right_beard:1-predictions[0].scaledMesh[411][1]/e.height,x_left_ear:predictions[0].scaledMesh[103][0]/e.width,y_left_ear:1-predictions[0].scaledMesh[103][1]/e.height,x_right_ear:predictions[0].scaledMesh[332][0]/e.width,y_right_ear:1-predictions[0].scaledMesh[332][1]/e.height,x_catfood:predictions[0].scaledMesh[175][0]/e.width,y_catfood:1-predictions[0].scaledMesh[175][1]/e.height,x_tail:predictions[0].scaledMesh[136][0]/e.width-.2,y_tail:1-predictions[0].scaledMesh[136][1]/e.height,x_miao:predictions[0].scaledMesh[136][0]/e.width-.3,y_miao:1-predictions[0].scaledMesh[136][1]/e.height},n=Math.atan((predictions[0].scaledMesh[168][0]-predictions[0].scaledMesh[94][0])/(predictions[0].scaledMesh[168][1]-predictions[0].scaledMesh[94][1])),E=isMouthOpen(predictions[0].scaledMesh,.8);if(E)eventStartTime=new Date;else(new Date-eventStartTime)/1e3<maxEventDuration&&(E=!0);Date.now();var T=[0,0,1,0,0,1,1,1],c=ApplyTransform(e.width,e.height,beardLFrames[0].width,beardLFrames[0].height,n,.1,l.x_left_beard,l.y_left_beard,T),_=ApplyTransform(e.width,e.height,beardRFrames[0].width,beardRFrames[0].height,n,.1,l.x_right_beard,l.y_right_beard,T),R=ApplyTransform(e.width,e.height,catfoodFrames[0].width,catfoodFrames[0].height,n,.13,l.x_left_ear,l.y_left_ear,T),m=ApplyTransform(e.width,e.height,earLFrames[0].width,earLFrames[0].height,n,.13,l.x_right_ear,l.y_right_ear,T),d=ApplyTransform(e.width,e.height,earRFrames[0].width,earRFrames[0].height,n,.26,l.x_catfood,l.y_catfood,T),s=ApplyTransform(e.width,e.height,tailFrames[0].width,tailFrames[0].height,n,.39,l.x_tail,l.y_tail,T),A=ApplyTransform(e.width,e.height,miaoFrames[0].width,miaoFrames[0].height,n,.39,l.x_miao,l.y_miao,T),h=new Float32Array([-1,-1,0,0,0,c[0],c[1],_[0],_[1],R[0],R[1],m[0],m[1],d[0],d[1],s[0],s[1],A[0],A[1],-1,1,0,0,1,c[4],c[5],_[4],_[5],R[4],R[5],m[4],m[5],d[4],d[5],s[4],s[5],A[4],A[5],1,1,0,1,1,c[6],c[7],_[6],_[7],R[6],R[7],m[6],m[7],d[6],d[7],s[6],s[7],A[6],A[7],1,-1,0,1,0,c[2],c[3],_[2],_[3],R[2],R[3],m[2],m[3],d[2],d[3],s[2],s[3],A[2],A[3]]),L=new Int16Array([0,1,2,0,2,3]),x=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,x),gl.bufferData(gl.ARRAY_BUFFER,h,gl.STATIC_DRAW);var u=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,u),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,L,gl.STATIC_DRAW),gl.useProgram(program);var D=gl.createTexture();gl.uniform1i(orntextureLocation1,1),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,D),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,beardLFrames[i%numFrame]);var U=gl.createTexture();gl.uniform1i(orntextureLocation2,2),gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,U),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,beardRFrames[i%numFrame]);var F=gl.createTexture();gl.uniform1i(orntextureLocation3,3),gl.activeTexture(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,F),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,earLFrames[i%numFrame]);var f=gl.createTexture();gl.uniform1i(orntextureLocation4,4),gl.activeTexture(gl.TEXTURE4),gl.bindTexture(gl.TEXTURE_2D,f),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,earRFrames[i%numFrame]);var w=gl.createTexture();gl.uniform1i(orntextureLocation5,5),gl.activeTexture(gl.TEXTURE5),gl.bindTexture(gl.TEXTURE_2D,w),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,catfoodFrames[i%numFrame]);var p=gl.createTexture();gl.uniform1i(orntextureLocation6,6),gl.activeTexture(gl.TEXTURE6),gl.bindTexture(gl.TEXTURE_2D,p),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tailFrames[i%numFrame]);var X=gl.createTexture();gl.uniform1i(orntextureLocation7,7),gl.activeTexture(gl.TEXTURE7),gl.bindTexture(gl.TEXTURE_2D,X),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,miaoFrames[0]);var P=gl.createTexture();gl.uniform1i(textureLocation,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,P),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,r);Date.now();t||(E=0),gl.uniform1i(mouthOpenFlagLocation,E),Date.now(),gl.viewport(0,0,gl.canvas.width,gl.canvas.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),Date.now(),Date.now(),gl.useProgram(program),gl.bindBuffer(gl.ARRAY_BUFFER,x),gl.vertexAttribPointer(positionLocation,3,gl.FLOAT,!1,76,0),gl.vertexAttribPointer(texcoordLocation,2,gl.FLOAT,!1,76,12),gl.vertexAttribPointer(orncoordLocation1,2,gl.FLOAT,!1,76,20),gl.vertexAttribPointer(orncoordLocation2,2,gl.FLOAT,!1,76,28),gl.vertexAttribPointer(orncoordLocation3,2,gl.FLOAT,!1,76,36),gl.vertexAttribPointer(orncoordLocation4,2,gl.FLOAT,!1,76,44),gl.vertexAttribPointer(orncoordLocation5,2,gl.FLOAT,!1,76,52),gl.vertexAttribPointer(orncoordLocation6,2,gl.FLOAT,!1,76,60),gl.vertexAttribPointer(orncoordLocation7,2,gl.FLOAT,!1,76,68),gl.enableVertexAttribArray(positionLocation),gl.enableVertexAttribArray(texcoordLocation),gl.enableVertexAttribArray(orncoordLocation1),gl.enableVertexAttribArray(orncoordLocation2),gl.enableVertexAttribArray(orncoordLocation3),gl.enableVertexAttribArray(orncoordLocation4),gl.enableVertexAttribArray(orncoordLocation5),gl.enableVertexAttribArray(orncoordLocation6),gl.enableVertexAttribArray(orncoordLocation7),gl.uniform2f(resolutionLocation,gl.canvas.width,gl.canvas.height),Date.now(),Date.now(),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),Date.now(),Date.now(),gl.readPixels(0,0,gl.canvas.width,gl.canvas.height,gl.RGBA,gl.UNSIGNED_BYTE,e.data),Date.now()}}function glRender(e){if(!gl)return;Date.now();var t=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,1,1,0,1,1]),a=new Int16Array([0,1,2,2,1,3]),r=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,r),gl.bufferData(gl.ARRAY_BUFFER,t,gl.STATIC_DRAW);var o=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,o),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,a,gl.STATIC_DRAW),gl.useProgram(program);var g=gl.createTexture();gl.uniform1i(textureLocation,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);const l=new Uint8ClampedArray(e.data,0,e.height*e.width*4);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,new ImageData(l,e.width,e.height));Date.now();Date.now(),gl.viewport(0,0,gl.canvas.width,gl.canvas.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),Date.now(),Date.now(),gl.useProgram(program),gl.bindBuffer(gl.ARRAY_BUFFER,r),gl.vertexAttribPointer(positionLocation,3,gl.FLOAT,!1,20,0),gl.vertexAttribPointer(texcoordLocation,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(positionLocation),gl.enableVertexAttribArray(texcoordLocation),gl.uniform2f(resolutionLocation,gl.canvas.width,gl.canvas.height),Date.now(),Date.now(),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),Date.now(),Date.now(),gl.readPixels(0,0,gl.canvas.width,gl.canvas.height,gl.RGBA,gl.UNSIGNED_BYTE,e.data),Date.now()}